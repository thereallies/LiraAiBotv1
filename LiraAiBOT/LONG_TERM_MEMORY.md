# üß† –î–æ–ª–≥–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –ø–∞–º—è—Ç—å LiraAI - –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

## ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

### 1. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

**–¢–∞–±–ª–∏—Ü–∞:** `dialog_history`

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| `id` | BIGSERIAL | –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID |
| `user_id` | TEXT | ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |
| `role` | TEXT | "user", "assistant", –∏–ª–∏ "system" |
| `content` | TEXT | –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è |
| `model` | TEXT | –ù–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏ |
| `created_at` | TIMESTAMP | –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è |
| `tokens_count` | INTEGER | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤ |
| `feedback_score` | INTEGER | –û—Ü–µ–Ω–∫–∞ (-1, 0, 1) |

**–ò–Ω–¥–µ–∫—Å—ã:**
- `idx_dialog_history_user_id` - –ø–æ–∏—Å–∫ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- `idx_dialog_history_created_at` - —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–µ
- `idx_dialog_history_user_created` - –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∏–Ω–¥–µ–∫—Å
- `idx_dialog_history_feedback` - –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –æ—Ü–µ–Ω–∫–∞–º

---

### 2. –§—É–Ω–∫—Ü–∏–∏ –≤ `users_db.py`

| –§—É–Ω–∫—Ü–∏—è | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|----------|
| `save_dialog_message()` | –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ) |
| `get_dialog_history()` | –ü–æ–ª—É—á–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ N —Å–æ–æ–±—â–µ–Ω–∏–π |
| `clear_dialog_history()` | –û—á–∏—â–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |
| `get_user_dialog_stats()` | –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –¥–∏–∞–ª–æ–≥–∞–º |
| `get_admin_dialog_history()` | –ò—Å—Ç–æ—Ä–∏—è –¥–ª—è –∞–¥–º–∏–Ω–∞ (–ø–æ–¥—Ä–æ–±–Ω–∞—è) |
| `cleanup_old_dialogs()` | –£–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è |
| `set_message_feedback()` | –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –æ—Ü–µ–Ω–∫—É üëç/üëé |

---

### 3. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –±–æ—Ç–∞

**–§–∞–π–ª:** `backend/api/telegram_polling.py`

**–õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã:**

```python
# 1. –ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –∏–∑ –ë–î (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 20 —Å–æ–æ–±—â–µ–Ω–∏–π)
history = db.get_dialog_history(user_id, limit=20)

# 2. –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ —Ñ–æ—Ä–º–∞—Ç –¥–ª—è LLM
chat_history = [
    {"role": msg["role"], "content": msg["content"]}
    for msg in history
]

# 3. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ LLM
response = await client.chat_completion(
    user_message=text,
    chat_history=chat_history,
    ...
)

# 4. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ë–î (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ)
db.save_dialog_message(user_id, "user", text, model=model)
db.save_dialog_message(user_id, "assistant", response, model=model)
```

---

### 4. –ê–¥–º–∏–Ω-–∫–æ–º–∞–Ω–¥—ã

#### `/admin history <user_id> [limit]`

–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

**–ü—Ä–∏–º–µ—Ä:**
```
/admin history 1658547011 50
```

**–û—Ç–≤–µ—Ç:**
```
üìö –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 1658547011

üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:
‚Ä¢ –í—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π: 156
‚Ä¢ –°–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: 78
‚Ä¢ –û—Ç–≤–µ—Ç—ã –±–æ—Ç–∞: 78
‚Ä¢ üëç –ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã—Ö: 12
‚Ä¢ üëé –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã—Ö: 2
‚Ä¢ –ü–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: 2026-02-27 21:00:00
‚Ä¢ –ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: 2026-02-28 10:30:00

üìù –ü–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å–æ–æ–±—â–µ–Ω–∏–π:
üë§ (groq-llama) [2026-02-28 10:25:00]: –ü—Ä–∏–≤–µ—Ç, –∫–∞–∫ –¥–µ–ª–∞?
ü§ñ (groq-llama) [2026-02-28 10:25:05]: –ü—Ä–∏–≤–µ—Ç! –Ø —Ö–æ—Ä–æ—à–æ, —Å–ø–∞—Å–∏–±–æ...
...
```

---

#### `/admin dialog_stats <user_id>`

–ü–æ–¥—Ä–æ–±–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–∏–∞–ª–æ–≥–∞.

**–ü—Ä–∏–º–µ—Ä:**
```
/admin dialog_stats 1658547011
```

---

#### `/admin cleanup_dialogs [days]`

–û—á–∏—â–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è —Å—Ç–∞—Ä—à–µ N –¥–Ω–µ–π.

**–ü—Ä–∏–º–µ—Ä:**
```
/admin cleanup_dialogs 30
```

**–û—Ç–≤–µ—Ç:**
```
üóëÔ∏è –ó–∞–ø—É—Å–∫–∞—é –æ—á–∏—Å—Ç–∫—É —Å–æ–æ–±—â–µ–Ω–∏–π —Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π...

‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!

–£–¥–∞–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π: 1234
```

---

### 5. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –∫–æ–º–∞–Ω–¥—ã

#### `/clear`

–û—á–∏—â–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```
/clear
```

---

### 6. Feedback —Å–∏—Å—Ç–µ–º–∞ (üëç/üëé)

**–¢–∞–±–ª–∏—Ü–∞:** `feedback`

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| `id` | BIGSERIAL | –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID |
| `user_id` | TEXT | ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |
| `message_id` | BIGINT | –°—Å—ã–ª–∫–∞ –Ω–∞ dialog_history |
| `score` | INTEGER | -1 (üëé) –∏–ª–∏ 1 (üëç) |
| `comment` | TEXT | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) |
| `created_at` | TIMESTAMP | –î–∞—Ç–∞ |

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:**

–î–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–Ω–æ–ø–æ–∫ üëç/üëé –ø–æ–¥ –æ—Ç–≤–µ—Ç–∞–º–∏:

```python
# –ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞
buttons = [
    [{"text": "üëç", "callback_data": f"feedback_{message_id}_1"},
     {"text": "üëé", "callback_data": f"feedback_{message_id}_-1"}]
]

# –û–±—Ä–∞–±–æ—Ç–∫–∞ callback
if callback_data.startswith("feedback_"):
    parts = callback_data.split("_")
    message_id = parts[1]
    score = int(parts[2])
    db.set_message_feedback(message_id, user_id, score)
```

---

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:

1. **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ**
   - `save_dialog_message()` –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç
   - –ë–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç —Å—Ä–∞–∑—É, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ —Ñ–æ–Ω–µ

2. **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏**
   - –ó–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 20 —Å–æ–æ–±—â–µ–Ω–∏–π
   - `limit=20` –≤ `get_dialog_history()`

3. **–ò–Ω–¥–µ–∫—Å—ã**
   - –í—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∏–Ω–¥–µ–∫—Å—ã —Å–æ–∑–¥–∞–Ω—ã
   - –ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ –ø–æ `user_id` + `created_at`

4. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ**
   - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫—ç—à–∏—Ä—É–µ—Ç—Å—è –≤ –ø–∞–º—è—Ç–∏
   - –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –Ω–µ —Ç—Ä–µ–±—É—é—Ç SQL

---

## üîí –ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å

- ‚úÖ –ö–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ—é –∏—Å—Ç–æ—Ä–∏—é
- ‚úÖ `user_id` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∏–∑–æ–ª—è—Ü–∏–∏
- ‚úÖ –ê–¥–º–∏–Ω –º–æ–∂–µ—Ç –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é –ª—é–±–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- ‚úÖ –ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (`remove_user`) –∏—Å—Ç–æ—Ä–∏—è —É–¥–∞–ª—è–µ—Ç—Å—è (CASCADE)

---

## üóëÔ∏è –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä–æ–π –∏—Å—Ç–æ—Ä–∏–∏

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è):

–î–æ–±–∞–≤—å –≤ `main.py` –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫—É—é –∑–∞–¥–∞—á—É:

```python
async def cleanup_task():
    """–ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é"""
    db = get_database()
    deleted = db.cleanup_old_dialogs(days_to_keep=90)
    logger.info(f"üóëÔ∏è –£–¥–∞–ª–µ–Ω–æ {deleted} —Å—Ç–∞—Ä—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π")

# –í main.py –¥–æ–±–∞–≤–∏—Ç—å –≤ startup_event()
asyncio.create_task(cleanup_task())
```

### –†—É—á–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞:

```
/admin cleanup_dialogs 30
```

---

## üìà –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

### 1. Fine-tuning –Ω–∞ –æ—Å–Ω–æ–≤–µ feedback

```sql
SELECT content, feedback_score
FROM dialog_history
WHERE feedback_score = 1
LIMIT 1000;
```

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –¥–æ–æ–±—É—á–µ–Ω–∏—è –º–æ–¥–µ–ª–∏.

### 2. –ê–Ω–∞–ª–∏–∑ –∫–∞—á–µ—Å—Ç–≤–∞ –æ—Ç–≤–µ—Ç–æ–≤

```sql
SELECT 
    model,
    COUNT(*) as total,
    COUNT(*) FILTER (WHERE feedback_score = 1) as positive,
    COUNT(*) FILTER (WHERE feedback_score = -1) as negative,
    ROUND(100.0 * COUNT(*) FILTER (WHERE feedback_score = 1) / COUNT(*), 2) as positive_pct
FROM dialog_history
WHERE feedback_score != 0
GROUP BY model;
```

### 3. –ü–æ–∏—Å–∫ –ø–æ –∏—Å—Ç–æ—Ä–∏–∏

```sql
SELECT * FROM dialog_history
WHERE user_id = '1658547011'
  AND content ILIKE '%–ø—Ä–∏–≤–µ—Ç%';
```

---

## üöÄ –ú–∏–≥—Ä–∞—Ü–∏—è

### 1. –°–æ–∑–¥–∞–π —Ç–∞–±–ª–∏—Ü—ã –≤ Supabase:

```bash
# –ó–∞–π–¥–∏ –≤ Supabase Dashboard -> SQL Editor
# –í—Å—Ç–∞–≤—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞:
supabase_memory_migration.sql
# –ù–∞–∂–º–∏ Run
```

### 2. –û–±–Ω–æ–≤–∏ —Ñ–∞–π–ª—ã –Ω–∞ GitHub:

```
backend/database/users_db.py
backend/api/telegram_polling.py
supabase_memory_migration.sql
```

### 3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ –±–æ—Ç–∞

### 4. –ü—Ä–æ–≤–µ—Ä—å:

```
# –ù–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç—É
–ü—Ä–∏–≤–µ—Ç!

# –ü—Ä–æ–≤–µ—Ä—å –∏—Å—Ç–æ—Ä–∏—é
/admin history 1658547011
```

---

## ‚úÖ –ò—Ç–æ–≥

| –§—É–Ω–∫—Ü–∏—è | –°—Ç–∞—Ç—É—Å |
|---------|--------|
| –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π | ‚úÖ –ì–æ—Ç–æ–≤–æ |
| –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ —Ñ–æ–Ω–µ | ‚úÖ –ì–æ—Ç–æ–≤–æ |
| –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ | ‚úÖ –ì–æ—Ç–æ–≤–æ |
| –ê–¥–º–∏–Ω-–∫–æ–º–∞–Ω–¥—ã | ‚úÖ –ì–æ—Ç–æ–≤–æ |
| –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä–æ–π –∏—Å—Ç–æ—Ä–∏–∏ | ‚úÖ –ì–æ—Ç–æ–≤–æ |
| Feedback —Å–∏—Å—Ç–µ–º–∞ | ‚úÖ –ì–æ—Ç–æ–≤–æ |
| –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å LLM | ‚úÖ –ì–æ—Ç–æ–≤–æ |

---

**–î–æ–ª–≥–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –ø–∞–º—è—Ç—å –≥–æ—Ç–æ–≤–∞!** üéâ

–ë–æ—Ç —Ç–µ–ø–µ—Ä—å –ø–æ–º–Ω–∏—Ç –≤—Å–µ —Ä–∞–∑–≥–æ–≤–æ—Ä—ã —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –¥–∞–∂–µ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞!
